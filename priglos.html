<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Giveaway System</title>
    <!-- Загружаем tmi.js через альтернативный CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tmi.js/1.8.5/tmi.min.js"></script>
    <style>
        :root {
            --primary: #9146FF;
            --secondary: #0e0e10;
            --dark: #1f1f23;
            --light: #efeff1;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--secondary);
            color: var(--light);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--dark);
            padding: 20px 0;
            border-bottom: 2px solid var(--primary);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            color: var(--primary);
            font-size: 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: var(--dark);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
            background-color: #2a2a2e;
            color: var(--light);
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #7c3cda;
        }
        
        button.secondary {
            background-color: #333;
        }
        
        button.secondary:hover {
            background-color: #444;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
        }
        
        .buttons button {
            flex: 1;
        }
        
        .participants-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .participant {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        
        .participant:hover {
            background-color: #2a2a2e;
        }
        
        .participant-info {
            display: flex;
            flex-direction: column;
        }
        
        .participant-name {
            font-weight: 600;
        }
        
        .participant-stats {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .winner {
            background-color: rgba(0, 184, 148, 0.2);
            border-left: 3px solid var(--success);
        }
        
        .subscriber {
            color: var(--success);
        }
        
        .winner-display {
            text-align: center;
            padding: 20px;
            background-color: rgba(145, 70, 255, 0.1);
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .winner-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        
        .history-date {
            color: #aaa;
            font-size: 0.8rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: var(--success);
        }
        
        .status-disconnected {
            background-color: var(--danger);
        }
        
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            background-color: #1a1a1d;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
            word-wrap: break-word;
        }
        
        .chat-message:hover {
            background-color: #2a2a2e;
        }
        
        .chat-user {
            font-weight: 600;
            color: var(--primary);
        }
        
        .chat-subscriber .chat-user {
            color: var(--success);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background-color: #2a2a2e;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .instructions {
            background-color: rgba(145, 70, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .instructions h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .code-block {
            background-color: #1a1a1d;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .badge-sub {
            background-color: var(--success);
            color: white;
        }
        
        .badge-mod {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-vip {
            background-color: var(--warning);
            color: black;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .success-message {
            color: var(--success);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .info-message {
            color: var(--primary);
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .token-help {
            background-color: rgba(253, 203, 110, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 3px solid var(--warning);
        }
        
        .token-format {
            background-color: rgba(0, 184, 148, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 3px solid var(--success);
        }
        
        .alternative-methods {
            background-color: rgba(116, 185, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #4a90e2;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="#9146FF">
                        <path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/>
                    </svg>
                    <h1>Twitch Giveaway System</h1>
                </div>
                <div class="connection-status">
                    <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                    <span id="statusText">Не подключено</span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="instructions">
            <h3>🚀 Инструкция по подключению к Twitch чату</h3>
            <ol>
                <li><strong>Получите OAuth токен:</strong> Перейдите на <a href="https://twitchtokengenerator.com/" target="_blank" style="color: var(--primary); font-weight: bold;">twitchtokengenerator.com</a></li>
                <li><strong>Выберите тип токена:</strong> "Bot Chat Token"</li>
                <li><strong>Авторизуйтесь через Twitch</strong> и скопируйте полученный токен</li>
                <li><strong>Введите данные ниже</strong> и нажмите "Подключиться к чату"</li>
                <li><strong>Для тестирования</strong> используйте демо-режим без токена</li>
            </ol>
        </div>

        <div class="alternative-methods">
            <h3>🔧 Если возникают проблемы с подключением:</h3>
            <p><strong>Способ 1:</strong> Используйте демо-режим для тестирования функционала</p>
            <p><strong>Способ 2:</strong> Скачайте файл и откройте локально (может потребоваться разрешить небезопасные скрипты)</p>
            <p><strong>Способ 3:</strong> Запустите на локальном сервере (например, через Live Server в VS Code)</p>
        </div>
        
        <div class="main-content">
            <div class="left-column">
                <div class="card">
                    <h2>🔗 Подключение к Twitch</h2>
                    <div class="form-group">
                        <label for="channelName">Имя канала</label>
                        <input type="text" id="channelName" placeholder="Введите имя канала (без twitch.tv/)" value="">
                    </div>
                    <div class="form-group">
                        <label for="oauthToken">OAuth токен</label>
                        <input type="password" id="oauthToken" placeholder="Введите ваш OAuth токен" value="">
                        <div class="token-format">
                            <strong>✅ Поддерживаемые форматы токенов:</strong>
                            <ul style="margin-top: 5px; margin-left: 15px;">
                                <li><code>oauth:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code> (с префиксом oauth:)</li>
                                <li><code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code> (без префикса)</li>
                            </ul>
                            <p style="margin-top: 5px; font-size: 0.9rem;">Система автоматически добавит префикс <code>oauth:</code> если его нет</p>
                        </div>
                        <div class="token-help">
                            <strong>Как получить токен:</strong> 
                            <a href="https://twitchtokengenerator.com/" target="_blank" style="color: var(--warning);">twitchtokengenerator.com</a> → 
                            "Bot Chat Token" → Авторизоваться → Скопировать токен
                        </div>
                    </div>
                    <div class="buttons">
                        <button id="connectBtn">🔗 Подключиться к чату</button>
                        <button id="disconnectBtn" class="secondary" disabled>❌ Отключиться</button>
                    </div>
                    <div class="buttons">
                        <button id="demoModeBtn" class="secondary">🎮 Включить демо-режим</button>
                    </div>
                    <div id="connectionMessage"></div>
                </div>
                
                <div class="card">
                    <h2>🎯 Настройки розыгрыша</h2>
                    <div class="form-group">
                        <label for="giveawayKeyword">Ключевое слово для участия</label>
                        <input type="text" id="giveawayKeyword" value="!розыгрыш" placeholder="Ключевое слово для участия">
                    </div>
                    <div class="form-group">
                        <label for="minMessages">Минимальное количество сообщений</label>
                        <input type="number" id="minMessages" value="3" min="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="subscribersOnly"> Только подписчики
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="excludeMods"> Исключить модераторов
                        </label>
                    </div>
                    <div class="buttons">
                        <button id="startGiveawayBtn" disabled>🚀 Начать розыгрыш</button>
                        <button id="drawWinnerBtn" class="secondary" disabled>🎲 Выбрать победителя</button>
                        <button id="redrawBtn" class="secondary" disabled>🔄 Переизбрать победителя</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>🏆 Победитель</h2>
                    <div id="winnerDisplay" class="winner-display">
                        <p>Победитель будет отображен здесь</p>
                    </div>
                </div>
            </div>
            
            <div class="right-column">
                <div class="card">
                    <h2>👥 Участники розыгрыша <span id="participantsCount">(0)</span></h2>
                    <div class="participants-list" id="participantsList">
                        <p class="no-participants">Участников пока нет</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2>💬 Чат <span id="chatStatus">(отключен)</span></h2>
                    <div class="chat-container" id="chatContainer">
                        <p class="no-chat">Сообщения чата появятся здесь после подключения</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" data-tab="stats">📊 Статистика</div>
                <div class="tab" data-tab="history">📜 История победителей</div>
                <div class="tab" data-tab="integration">⚙️ Настройки</div>
            </div>
            
            <div class="tab-content active" id="statsTab">
                <div class="card">
                    <h2>📊 Статистика розыгрыша</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalParticipants">0</div>
                            <div class="stat-label">Участников</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalMessages">0</div>
                            <div class="stat-label">Всего сообщений</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="subCount">0</div>
                            <div class="stat-label">Подписчиков</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="activeUsers">0</div>
                            <div class="stat-label">Активных пользователей</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="historyTab">
                <div class="card">
                    <h2>📜 История победителей</h2>
                    <div id="winnersHistory">
                        <p class="no-history">История победителей пуста</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="integrationTab">
                <div class="card">
                    <h2>⚙️ Настройки системы</h2>
                    <div class="form-group">
                        <label for="announceWinners">Объявлять победителей в чате</label>
                        <select id="announceWinners">
                            <option value="true">Да</option>
                            <option value="false">Нет</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="autoStart">Автоматически начинать розыгрыш при подключении</label>
                        <select id="autoStart">
                            <option value="false">Нет</option>
                            <option value="true">Да</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="saveHistory">Сохранять историю между сессиями</label>
                        <select id="saveHistory">
                            <option value="true">Да</option>
                            <option value="false">Нет</option>
                        </select>
                    </div>
                    <button id="saveSettingsBtn">💾 Сохранить настройки</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Основные переменные
        let participants = [];
        let chatMessages = [];
        let winnersHistory = [];
        let isConnected = false;
        let isGiveawayActive = false;
        let currentWinner = null;
        let twitchClient = null;
        let isDemoMode = false;
        let chatInterval = null;
        
        // Элементы DOM
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const demoModeBtn = document.getElementById('demoModeBtn');
        const startGiveawayBtn = document.getElementById('startGiveawayBtn');
        const drawWinnerBtn = document.getElementById('drawWinnerBtn');
        const redrawBtn = document.getElementById('redrawBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const participantsList = document.getElementById('participantsList');
        const chatContainer = document.getElementById('chatContainer');
        const winnerDisplay = document.getElementById('winnerDisplay');
        const winnersHistoryContainer = document.getElementById('winnersHistory');
        const totalParticipantsEl = document.getElementById('totalParticipants');
        const totalMessagesEl = document.getElementById('totalMessages');
        const subCountEl = document.getElementById('subCount');
        const activeUsersEl = document.getElementById('activeUsers');
        const participantsCountEl = document.getElementById('participantsCount');
        const chatStatusEl = document.getElementById('chatStatus');
        const connectionMessageEl = document.getElementById('connectionMessage');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        
        // Проверяем загрузилась ли библиотека tmi.js
        function checkTmiLoaded() {
            if (typeof tmi === 'undefined') {
                console.warn('tmi.js не загружена, используем альтернативный CDN');
                // Пытаемся загрузить через альтернативный CDN
                loadTmiFromAlternativeCDN();
                return false;
            }
            return true;
        }
        
        // Альтернативная загрузка tmi.js
        function loadTmiFromAlternativeCDN() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tmi.js/1.8.5/tmi.min.js';
            script.onload = function() {
                console.log('tmi.js успешно загружена через альтернативный CDN');
                showMessage('Библиотека tmi.js загружена. Теперь можно подключаться к чату.', 'success');
            };
            script.onerror = function() {
                console.error('Не удалось загрузить tmi.js через альтернативный CDN');
                showMessage('Не удалось загрузить библиотеку tmi.js. Используйте демо-режим или запустите файл локально.', 'error');
            };
            document.head.appendChild(script);
        }
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupEventListeners();
            updateUI();
            
            // Проверяем загрузку tmi.js
            setTimeout(() => {
                if (!checkTmiLoaded()) {
                    showMessage('Библиотека tmi.js загружается...', 'info');
                }
            }, 1000);
        });
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            connectBtn.addEventListener('click', connectToChat);
            disconnectBtn.addEventListener('click', disconnectFromChat);
            demoModeBtn.addEventListener('click', enableDemoMode);
            startGiveawayBtn.addEventListener('click', startGiveaway);
            drawWinnerBtn.addEventListener('click', drawWinner);
            redrawBtn.addEventListener('click', redrawWinner);
            saveSettingsBtn.addEventListener('click', saveSettings);
            
            // Табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
                });
            });
        }
        
        // Функция для форматирования токена
        function formatOAuthToken(token) {
            if (!token) return '';
            
            // Удаляем пробелы в начале и конце
            token = token.trim();
            
            // Если токен уже начинается с oauth:, возвращаем как есть
            if (token.startsWith('oauth:')) {
                return token;
            }
            
            // Если токен не начинается с oauth:, добавляем префикс
            return 'oauth:' + token;
        }
        
        // Подключение к Twitch чату
        async function connectToChat() {
            const channelName = document.getElementById('channelName').value.trim();
            let oauthToken = document.getElementById('oauthToken').value.trim();
            
            if (!channelName) {
                showMessage('Пожалуйста, введите имя канала', 'error');
                return;
            }
            
            if (!oauthToken) {
                showMessage('Введите OAuth токен для подключения к реальному чату', 'error');
                return;
            }
            
            // Проверяем загружена ли библиотека
            if (typeof tmi === 'undefined') {
                showMessage('Библиотека tmi.js не загружена. Используйте демо-режим или попробуйте позже.', 'error');
                return;
            }
            
            // Форматируем токен
            oauthToken = formatOAuthToken(oauthToken);
            
            showMessage('Подключение к чату...', 'info');
            
            try {
                // Создаем клиент Twitch
                twitchClient = new tmi.Client({
                    options: { 
                        debug: false,
                        skipUpdatingEmotesets: true
                    },
                    connection: {
                        reconnect: true,
                        secure: true
                    },
                    identity: {
                        username: channelName.toLowerCase(),
                        password: oauthToken
                    },
                    channels: [channelName.toLowerCase()]
                });
                
                // Подключаем обработчики событий
                twitchClient.on('connected', onConnected);
                twitchClient.on('message', onMessageHandler);
                twitchClient.on('disconnected', onDisconnected);
                
                // Подключаемся к чату
                await twitchClient.connect();
                
            } catch (error) {
                console.error('Ошибка подключения:', error);
                showMessage('Ошибка подключения к чату: ' + error.message, 'error');
            }
        }
        
        // Обработчик успешного подключения
        function onConnected(address, port) {
            const channelName = document.getElementById('channelName').value.trim();
            isConnected = true;
            isDemoMode = false;
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = `Подключено к ${channelName}`;
            chatStatusEl.textContent = '(активен)';
            
            showMessage(`✅ Успешно подключено к чату канала ${channelName}`, 'success');
            addSystemMessage(`✅ Успешно подключено к чату канала ${channelName}`);
            
            // Автозапуск розыгрыша если настроено
            const autoStart = document.getElementById('autoStart').value === 'true';
            if (autoStart) {
                setTimeout(() => startGiveaway(), 1000);
            }
            
            updateUI();
        }
        
        // Обработчик сообщений чата
        function onMessageHandler(channel, tags, message, self) {
            // Игнорируем сообщения от бота
            if (self) return;
            
            // Добавляем сообщение в чат
            const isSubscriber = tags.subscriber || false;
            const isMod = tags.mod || false;
            const isVip = tags.vip || false;
            
            addUserMessage(tags['display-name'] || tags.username, message, isSubscriber, isMod, isVip);
        }
        
        // Обработчик отключения
        function onDisconnected(reason) {
            isConnected = false;
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'Не подключено';
            chatStatusEl.textContent = '(отключен)';
            
            showMessage(`❌ Отключено от чата: ${reason}`, 'error');
            addSystemMessage(`❌ Отключено от чата: ${reason}`);
            
            updateUI();
        }
        
        // Включение демо-режима
        function enableDemoMode() {
            const channelName = document.getElementById('channelName').value.trim() || 'demo_channel';
            
            // Останавливаем предыдущее подключение если было
            if (twitchClient) {
                twitchClient.disconnect();
            }
            
            // Очищаем предыдущий интервал если был
            if (chatInterval) {
                clearInterval(chatInterval);
            }
            
            isConnected = true;
            isDemoMode = true;
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = `Демо-режим: ${channelName}`;
            chatStatusEl.textContent = '(демо)';
            
            // Очищаем чат
            chatContainer.innerHTML = '';
            
            showMessage(`🎮 Включен демо-режим для канала ${channelName}`, 'success');
            addSystemMessage(`🎮 Включен демо-режим для канала ${channelName}`);
            addSystemMessage('💬 Сообщения чата генерируются автоматически для тестирования системы');
            
            // Запускаем эмуляцию чата
            simulateChatMessages(channelName);
            
            updateUI();
        }
        
        // Отключение от чата
        function disconnectFromChat() {
            if (twitchClient) {
                twitchClient.disconnect();
            }
            
            // Останавливаем демо-режим если активен
            if (chatInterval) {
                clearInterval(chatInterval);
                chatInterval = null;
            }
            
            isConnected = false;
            isDemoMode = false;
            isGiveawayActive = false;
            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'Не подключено';
            chatStatusEl.textContent = '(отключен)';
            
            showMessage('🔌 Отключено от чата', 'info');
            addSystemMessage('🔌 Отключено от чата');
            
            updateUI();
        }
        
        // Начать розыгрыш
        function startGiveaway() {
            if (!isConnected) {
                showMessage('Сначала подключитесь к чату', 'error');
                return;
            }
            
            isGiveawayActive = true;
            participants = []; // Очищаем список участников при новом розыгрыше
            
            updateUI();
            
            // Уведомление в чат
            const keyword = document.getElementById('giveawayKeyword').value;
            addSystemMessage(`🎉 Розыгрыш начался! Напишите "${keyword}" в чат для участия.`);
            
            if (isDemoMode) {
                addSystemMessage('🎮 В демо-режиме участники добавляются автоматически при отправке любого сообщения');
            }
            
            showMessage('🎯 Розыгрыш начался! Участники могут писать ключевое слово в чат', 'success');
        }
        
        // Выбрать победителя
        function drawWinner() {
            if (!isGiveawayActive) {
                showMessage('Сначала начните розыгрыш', 'error');
                return;
            }
            
            if (participants.length === 0) {
                showMessage('Нет участников для розыгрыша', 'error');
                return;
            }
            
            // Фильтрация участников по критериям
            let eligibleParticipants = participants.filter(p => {
                const minMessages = parseInt(document.getElementById('minMessages').value) || 0;
                const subscribersOnly = document.getElementById('subscribersOnly').checked;
                const excludeMods = document.getElementById('excludeMods').checked;
                
                let eligible = p.messageCount >= minMessages;
                
                if (subscribersOnly) {
                    eligible = eligible && p.isSubscriber;
                }
                
                if (excludeMods) {
                    eligible = eligible && !p.isMod;
                }
                
                return eligible;
            });
            
            if (eligibleParticipants.length === 0) {
                showMessage('Нет участников, соответствующих критериям розыгрыша', 'error');
                return;
            }
            
            // Случайный выбор победителя
            const randomIndex = Math.floor(Math.random() * eligibleParticipants.length);
            currentWinner = eligibleParticipants[randomIndex];
            
            // Добавление в историю победителей
            const winnerRecord = {
                username: currentWinner.username,
                timestamp: new Date().toLocaleString('ru-RU'),
                messageCount: currentWinner.messageCount,
                isSubscriber: currentWinner.isSubscriber,
                isMod: currentWinner.isMod || false,
                isVip: currentWinner.isVip || false
            };
            
            winnersHistory.unshift(winnerRecord);
            
            // Отображение победителя
            displayWinner(currentWinner);
            
            // Обновление UI
            updateUI();
            updateHistory();
            
            // Уведомление в чат если настроено
            const announceWinners = document.getElementById('announceWinners').value === 'true';
            if (announceWinners && isConnected) {
                addSystemMessage(`🎉 Поздравляем, ${currentWinner.username}! Вы победили в розыгрыше!`);
                
                if (!isDemoMode && twitchClient) {
                    // В реальном чате отправляем сообщение
                    const channel = document.getElementById('channelName').value.trim();
                    twitchClient.say(channel, `🎉 Поздравляем, ${currentWinner.username}! Вы победили в розыгрыше!`);
                }
            }
            
            showMessage(`🏆 Победитель: ${currentWinner.username}`, 'success');
        }
        
        // Переизбрать победителя
        function redrawWinner() {
            if (!isGiveawayActive || participants.length === 0) {
                showMessage('Нет участников для переизбрания', 'error');
                return;
            }
            
            // Удаляем предыдущего победителя из истории
            if (winnersHistory.length > 0 && winnersHistory[0].username === currentWinner.username) {
                winnersHistory.shift();
                updateHistory();
            }
            
            // Выбираем нового победителя
            drawWinner();
        }
        
        // Отображение победителя
        function displayWinner(winner) {
            let badges = '';
            if (winner.isSubscriber) badges += '<span class="badge badge-sub">SUB</span> ';
            if (winner.isMod) badges += '<span class="badge badge-mod">MOD</span> ';
            if (winner.isVip) badges += '<span class="badge badge-vip">VIP</span> ';
            
            winnerDisplay.innerHTML = `
                <h3>🎉 ПОБЕДИТЕЛЬ 🎉</h3>
                <div class="winner-name">${badges}${winner.username}</div>
                <div class="winner-stats">
                    <p>📝 Сообщений в чате: ${winner.messageCount}</p>
                    <p>🔔 Статус подписки: ${winner.isSubscriber ? 'Подписчик' : 'Не подписчик'}</p>
                    <p>🕒 Время выбора: ${new Date().toLocaleString('ru-RU')}</p>
                </div>
            `;
        }
        
        // Обновление интерфейса
        function updateUI() {
            // Кнопки
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            startGiveawayBtn.disabled = !isConnected || isGiveawayActive;
            drawWinnerBtn.disabled = !isGiveawayActive || participants.length === 0;
            redrawBtn.disabled = !isGiveawayActive || currentWinner === null;
            demoModeBtn.disabled = isConnected;
            
            // Список участников
            updateParticipantsList();
            
            // Статистика
            updateStats();
        }
        
        // Обновление списка участников
        function updateParticipantsList() {
            participantsCountEl.textContent = `(${participants.length})`;
            
            if (participants.length === 0) {
                participantsList.innerHTML = '<p class="no-participants">Участников пока нет</p>';
                return;
            }
            
            participantsList.innerHTML = '';
            
            // Сортируем участников по количеству сообщений (по убыванию)
            const sortedParticipants = [...participants].sort((a, b) => b.messageCount - a.messageCount);
            
            sortedParticipants.forEach(participant => {
                const participantEl = document.createElement('div');
                participantEl.className = `participant ${participant.username === currentWinner?.username ? 'winner' : ''}`;
                
                let badges = '';
                if (participant.isSubscriber) badges += '<span class="badge badge-sub">SUB</span> ';
                if (participant.isMod) badges += '<span class="badge badge-mod">MOD</span> ';
                if (participant.isVip) badges += '<span class="badge badge-vip">VIP</span> ';
                
                participantEl.innerHTML = `
                    <div class="participant-info">
                        <div class="participant-name ${participant.isSubscriber ? 'subscriber' : ''}">
                            ${badges}${participant.username}
                        </div>
                        <div class="participant-stats">
                            📝 Сообщений: ${participant.messageCount} | 
                            🏆 Участвовал ранее: ${participant.previousWins > 0 ? 'Да (' + participant.previousWins + ' раз)' : 'Нет'}
                        </div>
                    </div>
                `;
                
                participantsList.appendChild(participantEl);
            });
        }
        
        // Обновление статистики
        function updateStats() {
            totalParticipantsEl.textContent = participants.length;
            
            const totalMessages = participants.reduce((sum, p) => sum + p.messageCount, 0);
            totalMessagesEl.textContent = totalMessages;
            
            const subCount = participants.filter(p => p.isSubscriber).length;
            subCountEl.textContent = subCount;
            
            // Активные пользователи (участники с >1 сообщением)
            const activeUsers = participants.filter(p => p.messageCount > 1).length;
            activeUsersEl.textContent = activeUsers;
        }
        
        // Обновление истории победителей
        function updateHistory() {
            if (winnersHistory.length === 0) {
                winnersHistoryContainer.innerHTML = '<p class="no-history">История победителей пуста</p>';
                return;
            }
            
            winnersHistoryContainer.innerHTML = '';
            
            winnersHistory.forEach(winner => {
                let badges = '';
                if (winner.isSubscriber) badges += '<span class="badge badge-sub">SUB</span> ';
                if (winner.isMod) badges += '<span class="badge badge-mod">MOD</span> ';
                if (winner.isVip) badges += '<span class="badge badge-vip">VIP</span> ';
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                historyItem.innerHTML = `
                    <div class="history-user">${badges}${winner.username}</div>
                    <div class="history-stats">
                        📝 Сообщений: ${winner.messageCount} | 
                        🔔 Подписчик: ${winner.isSubscriber ? 'Да' : 'Нет'}
                    </div>
                    <div class="history-date">🕒 ${winner.timestamp}</div>
                `;
                
                winnersHistoryContainer.appendChild(historyItem);
            });
        }
        
        // Добавление системного сообщения в чат
        function addSystemMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message system-message';
            messageEl.innerHTML = `<span style="color: var(--warning); font-weight: 600;">⚡ Система:</span> ${message}`;
            
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Сохраняем сообщение
            chatMessages.push({
                username: 'System',
                message: message,
                timestamp: new Date(),
                isSubscriber: false,
                isMod: false,
                isVip: false
            });
        }
        
        // Добавление сообщения пользователя в чат
        function addUserMessage(username, message, isSubscriber = false, isMod = false, isVip = false) {
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${isSubscriber ? 'chat-subscriber' : ''}`;
            
            let badges = '';
            if (isSubscriber) badges += '<span class="badge badge-sub">SUB</span> ';
            if (isMod) badges += '<span class="badge badge-mod">MOD</span> ';
            if (isVip) badges += '<span class="badge badge-vip">VIP</span> ';
            
            messageEl.innerHTML = `
                <span class="chat-user">${badges}${username}:</span> ${message}
            `;
            
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Сохраняем сообщение
            chatMessages.push({
                username: username,
                message: message,
                timestamp: new Date(),
                isSubscriber: isSubscriber,
                isMod: isMod,
                isVip: isVip
            });
            
            // Обработка участников розыгрыша
            if (isGiveawayActive) {
                const keyword = document.getElementById('giveawayKeyword').value.toLowerCase();
                
                // В демо-режиме добавляем всех, кто написал сообщение
                // В реальном режиме - только тех, кто использовал ключевое слово
                if (isDemoMode || message.toLowerCase().includes(keyword)) {
                    addParticipant(username, isSubscriber, isMod, isVip);
                }
            }
            
            // Обновляем статистику сообщений для пользователя
            updateUserMessageCount(username, isSubscriber, isMod, isVip);
        }
        
        // Добавление участника
        function addParticipant(username, isSubscriber, isMod, isVip) {
            // Проверяем, есть ли уже такой участник
            const existingParticipant = participants.find(p => p.username === username);
            
            if (existingParticipant) {
                // Обновляем информацию, если изменилась
                if (existingParticipant.isSubscriber !== isSubscriber) {
                    existingParticipant.isSubscriber = isSubscriber;
                }
                if (existingParticipant.isMod !== isMod) {
                    existingParticipant.isMod = isMod;
                }
                if (existingParticipant.isVip !== isVip) {
                    existingParticipant.isVip = isVip;
                }
                return;
            }
            
            // Добавляем нового участника
            const previousWins = winnersHistory.filter(w => w.username === username).length;
            
            participants.push({
                username: username,
                messageCount: 1, // Будет обновлено в updateUserMessageCount
                isSubscriber: isSubscriber,
                isMod: isMod || false,
                isVip: isVip || false,
                previousWins: previousWins,
                isWinner: false
            });
            
            updateUI();
        }
        
        // Обновление счетчика сообщений пользователя
        function updateUserMessageCount(username, isSubscriber, isMod, isVip) {
            const participant = participants.find(p => p.username === username);
            
            if (participant) {
                participant.messageCount++;
                participant.isSubscriber = isSubscriber; // Обновляем статус подписки
                participant.isMod = isMod; // Обновляем статус модератора
                participant.isVip = isVip; // Обновляем статус VIP
            } else {
                // Если пользователь еще не участник, но пишет в чат
                const previousWins = winnersHistory.filter(w => w.username === username).length;
                
                participants.push({
                    username: username,
                    messageCount: 1,
                    isSubscriber: isSubscriber,
                    isMod: isMod || false,
                    isVip: isVip || false,
                    previousWins: previousWins,
                    isWinner: false
                });
            }
            
            updateUI();
        }
        
        // Эмуляция сообщений чата для демонстрации
        function simulateChatMessages(channelName) {
            // Очищаем чат
            chatContainer.innerHTML = '';
            
            // Добавляем приветственное сообщение
            addSystemMessage(`🎮 Демо-режим: подключено к чату канала ${channelName}`);
            addSystemMessage('💬 Сообщения генерируются автоматически каждые 2-5 секунд');
            
            // Список случайных имен пользователей
            const usernames = [
                'StreamLover42', 'GamerPro', 'ChatEnthusiast', 'ViewerMax', 'TwitchFan99',
                'GameMaster', 'PixelArtist', 'CodeWizard', 'DesignGuru', 'TechGeek',
                'FunnyCommenter', 'SeriousViewer', 'CasualWatcher', 'HardcoreGamer', 'NightOwl'
            ];
            
            // Генерация случайных сообщений
            const messages = [
                'Привет всем! Как дела?',
                'Отличный стрим!',
                'Когда следующий розыгрыш?',
                'Люблю смотреть этот канал',
                'Кто еще ждет новую игру?',
                'Какой классный геймплей!',
                'Подскажите, как пройти этот уровень?',
                'Стример, ты лучший!',
                'Сколько часов ты уже стримишь?',
                '!розыгрыш',
                'Хочу участвовать в розыгрыше!',
                'Когда будет следующий стрим?',
                'Подписывайтесь на канал!',
                'Какой ваш любимый момент на стриме?',
                'Спасибо за контент!'
            ];
            
            // Функция для добавления случайного сообщения
            function addRandomMessage() {
                if (!isConnected || !isDemoMode) return;
                
                const randomUser = usernames[Math.floor(Math.random() * usernames.length)];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                const isSubscriber = Math.random() > 0.6; // 40% шанс быть подписчиком
                const isMod = Math.random() > 0.9; // 10% шанс быть модератором
                const isVip = Math.random() > 0.8; // 20% шанс быть VIP
                
                addUserMessage(randomUser, randomMessage, isSubscriber, isMod, isVip);
            }
            
            // Запускаем эмуляцию чата
            chatInterval = setInterval(addRandomMessage, 2000 + Math.random() * 3000);
        }
        
        // Показать сообщение
        function showMessage(message, type) {
            connectionMessageEl.textContent = message;
            connectionMessageEl.className = type === 'error' ? 'error-message' : 
                                          type === 'success' ? 'success-message' : 'info-message';
            
            // Автоматически скрываем сообщения через 5 секунд
            if (type !== 'error') {
                setTimeout(() => {
                    connectionMessageEl.textContent = '';
                }, 5000);
            }
        }
        
        // Загрузка настроек
        function loadSettings() {
            const savedSettings = localStorage.getItem('twitchGiveawaySettings');
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                if (settings.channelName) document.getElementById('channelName').value = settings.channelName;
                if (settings.oauthToken) document.getElementById('oauthToken').value = settings.oauthToken;
                if (settings.giveawayKeyword) document.getElementById('giveawayKeyword').value = settings.giveawayKeyword;
                if (settings.minMessages) document.getElementById('minMessages').value = settings.minMessages;
                if (settings.subscribersOnly !== undefined) document.getElementById('subscribersOnly').checked = settings.subscribersOnly;
                if (settings.excludeMods !== undefined) document.getElementById('excludeMods').checked = settings.excludeMods;
                if (settings.announceWinners) document.getElementById('announceWinners').value = settings.announceWinners;
                if (settings.autoStart) document.getElementById('autoStart').value = settings.autoStart;
                if (settings.saveHistory) document.getElementById('saveHistory').value = settings.saveHistory;
            }
            
            // Загрузка истории победителей
            const saveHistory = document.getElementById('saveHistory').value === 'true';
            if (saveHistory) {
                const savedHistory = localStorage.getItem('twitchGiveawayHistory');
                if (savedHistory) {
                    winnersHistory = JSON.parse(savedHistory);
                    updateHistory();
                }
            }
        }
        
        // Сохранение настроек
        function saveSettings() {
            const settings = {
                channelName: document.getElementById('channelName').value,
                oauthToken: document.getElementById('oauthToken').value,
                giveawayKeyword: document.getElementById('giveawayKeyword').value,
                minMessages: document.getElementById('minMessages').value,
                subscribersOnly: document.getElementById('subscribersOnly').checked,
                excludeMods: document.getElementById('excludeMods').checked,
                announceWinners: document.getElementById('announceWinners').value,
                autoStart: document.getElementById('autoStart').value,
                saveHistory: document.getElementById('saveHistory').value
            };
            
            localStorage.setItem('twitchGiveawaySettings', JSON.stringify(settings));
            
            // Сохраняем историю если настроено
            const saveHistory = document.getElementById('saveHistory').value === 'true';
            if (saveHistory) {
                localStorage.setItem('twitchGiveawayHistory', JSON.stringify(winnersHistory));
            } else {
                localStorage.removeItem('twitchGiveawayHistory');
            }
            
            showMessage('✅ Настройки сохранены!', 'success');
        }
    </script>
</body>
</html>
